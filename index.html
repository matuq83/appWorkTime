<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Work Time</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
        }

        .card {
            border-radius: 10px;
            background-color: #d9d9d9;
        }

        .table thead th {
            color: black;
        }
        .dark-mode .card{
            background-color: #2d3748;
        }

        .dark-mode .card-body{
            color: #fff;
        }

        .dark-mode .card-title{
            color: #fff;
        }

        .dark-mode .navbar-light .navbar-brand {
            color: #fff;
        }

        .dark-mode {
            background-color: #1a202c;
            color: #f7f3f3;
        }

        .dark-mode navbar-light .navbar-toggler-icon {
            background-image: url(data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' color='#ffff' width='30' height='30' viewBox='0 0 30 30'%3e%3cpath stroke='rgba%280, 0, 0, 0.5%29' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e);
        }

        .dark-mode .bg-light {
            background-color: #2d3748 !important;
        }

        .dark-mode .navbar-text {
            color: #ffff;
        }

        .dark-mode .navbar-light .navbar-nav .nav-link {
            color: #a0aec0 !important;
        }

        .dark-mode .table thead th {
                color: #fff;
            }

        .dark-mode .table td, .table th {
            color: #fff;
            }

        .fixed-buttons {
            position: sticky;
            bottom: 0;
            background-color: white;
            z-index: 10;
            padding: 10px 0;
        }

        .dark-mode .fixed-buttons {
            background-color: #2d3748;
        }



        #back-to-top {
            border-radius: 100px;
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: none;
            z-index: 1000;
        }

        #back-to-top i {
            font-size: 24px;
        }

        footer {
            text-align: center;
            margin-top: 30px;
        }

        .navbar-brand img {
            width: 40px;
            height: 40px;
            margin-right: 10px;
        }

        .welcome-text {
            margin-left: 10px;
        }

        *, ::after, ::before {
            padding: 3px;
            box-sizing: border-box;
            }

        @media (max-width: 991px) {
            .navbar-nav {
                margin-top: 15px;
            }
            
            .welcome-text {
                margin-left: 0;
                margin-bottom: 10px;
            }

            .h1, h1 {
                font-size: 1.5rem;
            }

            .table thead th {
                font-size: 0.7rem;
            }


            .table td, .table th {
                font-size: 14px;
            }

            .h4, h4 {
                font-size: 1.2rem;
            }
            .btn:not(:disabled):not(.disabled) {
                margin-top: 6px;
                margin-right: 6px;
                cursor: pointer;
            }

        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand" href="#">
            <img src="./img/worktime-logo-alt.svg" alt="Logo"> Work Time
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <div class="navbar-nav mr-auto">
                <span class="welcome-text navbar-text d-none">
                    ¡Buen día, <span id="username">Usuario</span>!
                </span>
            </div>
            <ul class="navbar-nav">
                <li class="nav-item">
                    <button id="toggle-theme" class="btn btn-secondary mr-2">
                        <i class="fas fa-sun"></i> <span class="theme-text">Modo Día</span>
                    </button>
                </li>
                <li class="nav-item">
                    <button id="logout" class="btn btn-danger d-none">Cerrar Sesión</button>
                </li>
            </ul>
        </div>
    </nav>

    <div class="container mt-5">
        <!-- Registro de Usuario -->
        <div id="register-page" class="d-none">
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Registro de Usuario</h5>
                            <form id="register-form">
                                <div class="form-group">
                                    <label for="first-name">Nombre</label>
                                    <input type="text" class="form-control" id="first-name" required>
                                </div>
                                <div class="form-group">
                                    <label for="last-name">Apellido</label>
                                    <input type="text" class="form-control" id="last-name" required>
                                </div>
                                <div class="form-group">
                                    <label for="email">Correo Electrónico</label>
                                    <input type="email" class="form-control" id="email" required>
                                </div>
                                <div class="form-group">
                                    <label for="sector">Sector</label>
                                    <select id="sector" class="form-control" required>
                                        <option value="alimentos-bebidas">Alimentos y Bebidas</option>
                                        <option value="cocina">Cocina</option>
                                        <option value="recepcion">Recepción</option>
                                        <option value="ama-de-llaves">Ama de Llaves</option>
                                        <option value="mantenimiento">Mantenimiento</option>
                                        <option value="administracion">Administración</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="password">Contraseña</label>
                                    <input type="password" class="form-control" id="password" required>
                                </div>
                                <button type="submit" class="btn btn-primary">Registrar</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Login Page -->
        <div id="login-page">
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Iniciar Sesión</h5>
                            <form id="login-form">
                                <div class="form-group">
                                    <label for="login-email">Correo Electrónico</label>
                                    <input type="email" class="form-control" id="login-email" required>
                                </div>
                                <div class="form-group">
                                    <label for="login-password">Contraseña</label>
                                    <input type="password" class="form-control" id="login-password" required>
                                </div>
                                <button type="submit" class="btn btn-primary">Ingresar</button>
                                <button type="button" class="btn btn-secondary" id="register-btn">Crear Cuenta</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Work Records -->
        <div id="work-records" class="d-none">
            <h1>Registro de Jornadas Trabajadas</h1>
            <form id="work-form">
                <div class="form-row">
                    <div class="form-group col-md-4">
                        <label for="work-date">Fecha de Trabajo</label>
                        <input type="date" id="work-date" class="form-control" required>
                    </div>
                    <div class="form-group col-md-4">
                        <label for="start-time">Hora de Ingreso</label>
                        <input type="time" id="start-time" class="form-control" required>
                    </div>
                    <div class="form-group col-md-4">
                        <label for="end-time">Hora de Egreso</label>
                        <input type="time" id="end-time" class="form-control" required>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">Registrar</button>
            </form>

            <table class="table table-striped mt-3">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Hora de Ingreso</th>
                        <th>Hora de Egreso</th>
                        <th>Horas Totales</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="work-table"></tbody>
            </table>

            <div id="total-hours">
                <h4>Total de Jornadas Trabajadas: <span id="total-jornadas">0</span> | Total de Horas: <span id="total-horas">0</span></h4>
            </div>

            <div class="fixed-buttons text-center">
                <button id="clear-list" class="btn btn-danger">Limpiar Lista</button>
                <button id="export-excel" class="btn btn-success">Descargar en Excel</button>
            </div>
        </div>
    </div>

    <button id="back-to-top" class="btn btn-primary">
        <i class="fas fa-arrow-up"></i>
    </button>

    <footer class="mt-4">
        <p>&copy; 2024 Work Time | Pwd by Matias Quintana </p>
    </footer>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAHo3oIecxPdMFJzUm9DJYPn-VS9cSNx9k",
            authDomain: "work-time-app-mq.firebaseapp.com",
            projectId: "work-time-app-mq",
            storageBucket: "work-time-app-mq.firebasestorage.app",
            messagingSenderId: "627385644653",
            appId: "1:627385644653:web:bc22287f25b39fabf93164"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
    </script>
    <!-- <script>
        $(function () {
            const loginPage = $("#login-page");
            const registerPage = $("#register-page");
            const workRecords = $("#work-records");
            const backToTopButton = $("#back-to-top");
            const toggleThemeButton = $("#toggle-theme");
            const welcomeText = $(".welcome-text");
            const usernameSpan = $("#username");
            const logoutButton = $("#logout");

            let workData = [];
            let editingIndex = -1;

            // Show Register Page
            $("#register-btn").on("click", function () {
                loginPage.addClass("d-none");
                registerPage.removeClass("d-none");
            });

            // Show Login Page
            $("#login-form").on("submit", function (e) {
                e.preventDefault();
                loginPage.addClass("d-none");
                workRecords.removeClass("d-none");
                welcomeText.removeClass("d-none");
                logoutButton.removeClass("d-none");
                usernameSpan.text($("#login-email").val().split('@')[0]); // Show only the username part of email
                backToTopButton.show();
            });

            // Handle Registration Form
            $("#register-form").on("submit", function (e) {
                e.preventDefault();
                alert("Usuario registrado con éxito.");
                registerPage.addClass("d-none");
                loginPage.removeClass("d-none");
            });

            // Toggle Theme (Dark/Light Mode)
            toggleThemeButton.on("click", function () {
                $("body").toggleClass("dark-mode");
                const themeText = $("body").hasClass("dark-mode") ? "Modo Noche" : "Modo Día";
                toggleThemeButton.find(".theme-text").text(themeText);
            });

            // Log Out
            $("#logout").on("click", function () {
                workRecords.addClass("d-none");
                loginPage.removeClass("d-none");
                welcomeText.addClass("d-none");
                logoutButton.addClass("d-none");
                $("#login-form")[0].reset();
            });

            // Add Work Record
            $("#work-form").on("submit", function (e) {
                e.preventDefault();
                const date = $("#work-date").val();
                const startTime = $("#start-time").val();
                const endTime = $("#end-time").val();

                // Prevent duplicate entries
                if (workData.some(item => item.date === date && item.startTime === startTime && item.endTime === endTime && editingIndex === -1)) {
                    alert("Ya existe una jornada con estas horas.");
                    return;
                }

                const hoursWorked = calculateHours(startTime, endTime);

                if (editingIndex >= 0) {
                    workData[editingIndex] = { date, startTime, endTime, hoursWorked };
                    editingIndex = -1;
                } else {
                    workData.push({ date, startTime, endTime, hoursWorked });
                }

                updateWorkTable();
            });

            // Edit Work Record
            $(document).on("click", ".edit-button", function () {
                const row = $(this).closest("tr");
                const data = row.children("td");
                const date = data[0].textContent;
                const startTime = data[1].textContent;
                const endTime = data[2].textContent;

                editingIndex = row.index();
                $("#work-date").val(date);
                $("#start-time").val(startTime);
                $("#end-time").val(endTime);
            });

            // Delete Work Record
            $(document).on("click", ".delete-button", function () {
                const row = $(this).closest("tr");
                const date = row.children("td").eq(0).text();
                workData = workData.filter(item => item.date !== date);
                updateWorkTable();
            });

            // Update Work Table
            function updateWorkTable() {
                const tbody = $("#work-table").empty();
                let totalHours = 0;
                workData.forEach((item, index) => {
                    totalHours += parseFloat(item.hoursWorked);
                    tbody.append(`
                        <tr>
                            <td>${item.date}</td>
                            <td>${item.startTime}</td>
                            <td>${item.endTime}</td>
                            <td>${item.hoursWorked}</td>
                            <td>
                                <button class="btn btn-warning edit-button">Editar</button>
                                <button class="btn btn-danger delete-button">Eliminar</button>
                            </td>
                        </tr>
                    `);
                });
                $("#total-jornadas").text(workData.length);
                $("#total-horas").text(totalHours.toFixed(2));
            }

            // Calculate Hours Worked
            function calculateHours(startTime, endTime) {
                const start = new Date(`1970-01-01T${startTime}:00`);
                const end = new Date(`1970-01-01T${endTime}:00`);
                const diff = (end - start) / 1000 / 60 / 60;
                return diff.toFixed(2);
            }

            // Clear List
            $("#clear-list").on("click", function () {
                workData = [];
                updateWorkTable();
            });

            // Export to Excel
            $("#export-excel").on("click", function () {
                const ws = XLSX.utils.table_to_sheet(document.querySelector("table"));
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Jornadas");
                XLSX.writeFile(wb,"jornadas_trabajadas.xlsx");
            });

            // Show Back to Top Button
            $(window).on("scroll", function () {
                if ($(window).scrollTop() > 300) {
                    backToTopButton.show();
                } else {
                    backToTopButton.hide();
                }
            });

            // Scroll to Top
            backToTopButton.on("click", function () {
                $("html, body").animate({ scrollTop: 0 }, 500);
            });
        });
    </script> -->
    
<script src="https://www.gstatic.com/firebasejs/9.0.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.2/firebase-firestore-compat.js"></script>

<script>
    // Initialize Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyAHo3oIecxPdMFJzUm9DJYPn-VS9cSNx9k",
        authDomain: "work-time-app-mq.firebaseapp.com",
        projectId: "work-time-app-mq",
        storageBucket: "work-time-app-mq.firebasestorage.app",
        messagingSenderId: "627385644653",
        appId: "1:627385644653:web:bc22287f25b39fabf93164"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    $(function () {
        const loginPage = $("#login-page");
        const registerPage = $("#register-page");
        const workRecords = $("#work-records");
        const backToTopButton = $("#back-to-top");
        const toggleThemeButton = $("#toggle-theme");
        const welcomeText = $(".welcome-text");
        const usernameSpan = $("#username");
        const logoutButton = $("#logout");

        let workData = [];
        let editingIndex = -1;

        // Firebase Auth State Observer
        auth.onAuthStateChanged((user) => {
            if (user) {
                loginPage.addClass("d-none");
                workRecords.removeClass("d-none");
                welcomeText.removeClass("d-none");
                logoutButton.removeClass("d-none");
                usernameSpan.text(user.email.split('@')[0]);
                backToTopButton.show();
                loadUserData(user.uid);
            } else {
                workRecords.addClass("d-none");
                loginPage.removeClass("d-none");
                welcomeText.addClass("d-none");
                logoutButton.addClass("d-none");
            }
        });

        // Load User Data from Firebase
        function loadUserData(userId) {
            db.collection('users')
                .doc(userId)
                .collection('workRecords')
                .orderBy('date')
                .get()
                .then((querySnapshot) => {
                    workData = [];
                    querySnapshot.forEach((doc) => {
                        workData.push({ ...doc.data(), id: doc.id });
                    });
                    updateWorkTable();
                })
                .catch((error) => {
                    console.error("Error loading data:", error);
                });
        }

        // Show Register Page
        $("#register-btn").on("click", function () {
            loginPage.addClass("d-none");
            registerPage.removeClass("d-none");
        });

        // Handle Login
        $("#login-form").on("submit", function (e) {
            e.preventDefault();
            const email = $("#login-email").val();
            const password = $("#login-password").val();

            auth.signInWithEmailAndPassword(email, password)
                .catch((error) => {
                    alert("Error de inicio de sesión: " + error.message);
                });
        });

        // Handle Registration
        $("#register-form").on("submit", function (e) {
            e.preventDefault();
            const email = $("#register-email").val();
            const password = $("#register-password").val();

            auth.createUserWithEmailAndPassword(email, password)
                .then(() => {
                    alert("Usuario registrado con éxito.");
                    registerPage.addClass("d-none");
                    loginPage.removeClass("d-none");
                })
                .catch((error) => {
                    alert("Error de registro: " + error.message);
                });
        });

        // Log Out
        $("#logout").on("click", function () {
            auth.signOut()
                .then(() => {
                    workData = [];
                    updateWorkTable();
                })
                .catch((error) => {
                    console.error("Error al cerrar sesión:", error);
                });
        });

        // Add Work Record
        $("#work-form").on("submit", function (e) {
            e.preventDefault();
            const date = $("#work-date").val();
            const startTime = $("#start-time").val();
            const endTime = $("#end-time").val();

            if (startTime >= endTime) {
                alert("La hora de ingreso debe ser menor a la hora de egreso.");
                return;
            }

            // Prevent duplicate entries
            if (workData.some(item => item.date === date && item.startTime === startTime && item.endTime === endTime && editingIndex === -1)) {
                alert("Ya existe una jornada con estas horas.");
                return;
            }

            const hoursWorked = calculateHours(startTime, endTime);
            const record = { date, startTime, endTime, hoursWorked };

            const user = auth.currentUser;
            if (!user) return;

            if (editingIndex >= 0) {
                // Update existing record
                db.collection('users')
                    .doc(user.uid)
                    .collection('workRecords')
                    .doc(workData[editingIndex].id)
                    .update(record)
                    .then(() => {
                        editingIndex = -1;
                        loadUserData(user.uid);
                        $("#work-form")[0].reset();
                    })
                    .catch((error) => {
                        console.error("Error updating record:", error);
                    });
            } else {
                // Add new record
                db.collection('users')
                    .doc(user.uid)
                    .collection('workRecords')
                    .add(record)
                    .then(() => {
                        loadUserData(user.uid);
                        $("#work-form")[0].reset();
                    })
                    .catch((error) => {
                        console.error("Error adding record:", error);
                    });
            }
        });

        // Edit Work Record
        $(document).on("click", ".edit-button", function () {
            const row = $(this).closest("tr");
            editingIndex = workData.findIndex(item => item.id === $(this).data('id'));
            const record = workData[editingIndex];
            
            $("#work-date").val(record.date);
            $("#start-time").val(record.startTime);
            $("#end-time").val(record.endTime);
        });

        // Delete Work Record
        $(document).on("click", ".delete-button", function () {
            const user = auth.currentUser;
            if (!user) return;

            const recordId = $(this).data('id');
            
            db.collection('users')
                .doc(user.uid)
                .collection('workRecords')
                .doc(recordId)
                .delete()
                .then(() => {
                    loadUserData(user.uid);
                })
                .catch((error) => {
                    console.error("Error deleting record:", error);
                });
        });

        // Update Work Table
        function updateWorkTable() {
            const tbody = $("#work-table").empty();
            let totalHours = 0;
            
            workData.forEach((item) => {
                totalHours += parseFloat(item.hoursWorked);
                tbody.append(`
                    <tr>
                        <td>${item.date}</td>
                        <td>${item.startTime}</td>
                        <td>${item.endTime}</td>
                        <td>${item.hoursWorked}</td>
                        <td>
                            <button class="btn btn-warning edit-button" data-id="${item.id}">Editar</button>
                            <button class="btn btn-danger delete-button" data-id="${item.id}">Eliminar</button>
                        </td>
                    </tr>
                `);
            });
            
            $("#total-jornadas").text(workData.length);
            $("#total-horas").text(totalHours.toFixed(2));
        }

        // Calculate Hours
        function calculateHours(startTime, endTime) {
            const start = new Date(`1970-01-01T${startTime}:00`);
            const end = new Date(`1970-01-01T${endTime}:00`);
            const diff = (end - start) / 1000 / 60 / 60;
            return diff.toFixed(2);
        }

        // Clear List
        $("#clear-list").on("click", function () {
            const user = auth.currentUser;
            if (!user) return;

            if (confirm("¿Está seguro de que desea borrar todos los registros?")) {
                const batch = db.batch();
                workData.forEach((record) => {
                    const ref = db.collection('users').doc(user.uid).collection('workRecords').doc(record.id);
                    batch.delete(ref);
                });

                batch.commit()
                    .then(() => {
                        workData = [];
                        updateWorkTable();
                    })
                    .catch((error) => {
                        console.error("Error clearing records:", error);
                    });
            }
        });

        // Export to Excel (keeping your existing implementation)
        $("#export-excel").on("click", function () {
            const ws = XLSX.utils.table_to_sheet(document.querySelector("table"));
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Jornadas");
            XLSX.writeFile(wb, "jornadas_trabajadas.xlsx");
        });

        // Back to Top functionality
        $(window).on("scroll", function () {
            if ($(window).scrollTop() > 300) {
                backToTopButton.show();
            } else {
                backToTopButton.hide();
            }
        });

        backToTopButton.on("click", function () {
            $("html, body").animate({ scrollTop: 0 }, 500);
        });

        // Theme Toggle
        toggleThemeButton.on("click", function () {
            $("body").toggleClass("dark-mode");
            const themeText = $("body").hasClass("dark-mode") ? "Modo Noche" : "Modo Día";
            toggleThemeButton.find(".theme-text").text(themeText);
        });
    });
</script>
</body>

</html>